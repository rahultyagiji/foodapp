"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var item_service_1 = require("../services/item.service");
var router_1 = require("@angular/router");
var router_2 = require("@angular/router");
// import { MapboxViewApi, Viewport as MapboxViewport } from "nativescript-mapbox";
var nativescript_angular_1 = require("nativescript-angular");
var observable_array_1 = require("data/observable-array");
var auth_service_1 = require("../services/auth.service");
var order_service_1 = require("../services/order.service");
var firebase = require("nativescript-plugin-firebase");
//trying location
var nativescript_geolocation_1 = require("nativescript-geolocation");
var color_1 = require("tns-core-modules/color");
var page_1 = require("tns-core-modules/ui/page");
// import {and} from "../../platforms/ios/DQCafev02/app/tns_modules/@angular/router/src/utils/collection";
// var Vibrate = require("nativescript-vibrate").Vibrate;
// let vibrator = new Vibrate();
var ItemsComponent = /** @class */ (function () {
    function ItemsComponent(itemService, router, route, routerextensions, auth, orderservice, _page) {
        this.itemService = itemService;
        this.router = router;
        this.route = route;
        this.routerextensions = routerextensions;
        this.auth = auth;
        this.orderservice = orderservice;
        this._page = _page;
        this.tabSelected = 0;
        this.items = [];
        this.myItems = [];
        this.orderList = [];
        this._orderList = new observable_array_1.ObservableArray([]);
        this._items = new observable_array_1.ObservableArray([]);
        this.orderComplexLocal = [];
        this.orderComplexLocalFilter = [];
        this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
        this._order = new observable_array_1.ObservableArray([]);
        this.frequentCafes = [];
        this.startLocation = new nativescript_geolocation_1.Location();
        this.username = "";
        if (this.route.snapshot.params["tabId"] != null && this.route.snapshot.params["tabId"] == 1) {
            this.tabSelectedIndex = 1;
        }
        else {
            this.tabSelectedIndex = 0;
        }
    }
    ItemsComponent.prototype.ngOnInit = function () {
        var _this = this;
        this._page.actionBarHidden = true;
        if (this.items != []) {
            this.itemService.load()
                .subscribe(function (items) {
                _this._items = new observable_array_1.ObservableArray(items);
                _this.items = [];
                _this._items.forEach(function (x) {
                    _this.items.push(x);
                });
                _this.myItems.length = 0;
                _this.filterByLocation();
            });
        }
        else {
            console.log("not loading again");
        }
        //order load for your picks
        firebase.getCurrentUser()
            .then(function (token) {
            console.log(token);
            _this.orderservice.loadOrder(token.uid)
                .subscribe(function (orderlist) {
                _this.orderComplexLocal = [];
                _this._orderList = new observable_array_1.ObservableArray(orderlist);
                _this.orderList = [];
                _this._orderList.forEach(function (x) {
                    _this.orderList.push(x);
                });
                _this.orderList.forEach(function (x) {
                    //get Cafe details
                    _this.orderservice.getOrderDetails(x.cafe, x.orderNo)
                        .then(function (result) {
                        _this.orderDisplay.cafeOwner = _this.itemService.getCafeInfo(x.cafe).name;
                        _this.orderDisplay.imgSrc = _this.itemService.getCafeInfo(x.cafe).imgSrc;
                        _this.orderDisplay.key = result.value.key;
                        _this.orderDisplay.uid = result.value.uid;
                        _this.orderDisplay.status = result.value.status;
                        _this.orderDisplay.orderNo2 = result.value.orderNo2;
                        _this.orderDisplay.order = result.value.order;
                        _this.orderDisplay.total = _this.totalPrice(_this.orderDisplay.order);
                        _this.orderComplexLocal.push(_this.orderDisplay);
                        _this.onTapCurrentOrder();
                        _this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
                            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
                    });
                });
            });
            _this.ontapListofFrequent(token.uid);
        });
    };
    //Frequently visited - to be completed ....
    ItemsComponent.prototype.ontapListofFrequent = function (token) {
        var _this = this;
        var counts;
        this.orderservice.frequentCafe(token)
            .then(function (res) {
            Object.keys(res.value).forEach(function (x) {
                _this.frequentCafes.push(res.value[x].cafe);
            });
        })
            .catch();
    };
    //Navitage to next screen
    ItemsComponent.prototype.jumptoMenu = function (cafeId, args) {
        var page = args.object;
        var view = page.getViewById("cafename");
        view.backgroundColor = new color_1.Color("#f0f0f0");
        view.animate({ backgroundColor: new color_1.Color("white"), duration: 200 });
        this.routerextensions.navigate(["/cafe", cafeId]);
    };
    //
    // //TabView controls
    ItemsComponent.prototype.changeTab = function () {
        if (this.tabSelectedIndex === 0) {
            this.tabSelectedIndex = 1;
        }
        else if (this.tabSelectedIndex === 1) {
            this.tabSelectedIndex = 2;
        }
        else if (this.tabSelectedIndex === 2) {
            this.tabSelectedIndex = 0;
        }
    };
    // search bar
    ItemsComponent.prototype.onTextChanged = function (args) {
        var searchBar = args.object;
        if (searchBar.text != "") {
            var searchValue_1 = searchBar.text.toLowerCase();
            if (searchBar.text != "") {
                this.myItems = this.items.filter(function (item) {
                    return (item.name + " " + item.name).toLowerCase().indexOf(searchValue_1.toLowerCase()) > -1;
                });
            }
            else {
                setTimeout(function () {
                    searchBar.dismissSoftInput();
                }, 300);
            }
        }
        else {
            // this.myItems.length=0;
            // this.filterByLocation();
        }
    };
    ItemsComponent.prototype.searchLoaded = function (event) {
        this.searchPhrase = "";
        event.object.android.setFocusable(false);
    };
    ItemsComponent.prototype.onSubmit = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onClear = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onRegister = function () {
        this.routerextensions.navigate(['register']);
    };
    ItemsComponent.prototype.onSignin = function () {
        this.routerextensions.navigate(['signin']);
    };
    ItemsComponent.prototype.onSignout = function () {
        this.auth.signout();
    };
    //For your picks...
    ItemsComponent.prototype.topThreeCafes = function () {
        this.orderservice.frequentCafe("CBNUluA6FogVIkOSlD4WKOFvMjf1");
    };
    ItemsComponent.prototype.onTapCurrentOrder = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status != "collected";
        });
    };
    ItemsComponent.prototype.onTapPastOrders = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status === "collected";
        });
    };
    ItemsComponent.prototype.totalPrice = function (order) {
        var total = "0";
        order.forEach(function (x) {
            //for total
            total = (Math.round((parseFloat(total) + parseFloat(x.priceQuantity)) * 100) / 100).toString();
        });
        return total;
    };
    ItemsComponent.prototype.filterByLocation = function () {
        var _this = this;
        var date = new Date();
        this.items.forEach(function (x) {
            _this.myItems.length = 0;
            var that = _this;
            nativescript_geolocation_1.getCurrentLocation({ desiredAccuracy: 1, updateDistance: 10, maximumAge: 20000, timeout: 5000 }).
                then(function (loc) {
                if (loc) {
                    var a = nativescript_geolocation_1.distance(loc, { "latitude": x.lat, "longitude": x.lng, "direction": 0, "horizontalAccuracy": 14,
                        "verticalAccuracy": 14, "speed": 0, "altitude": 89, "timestamp": date });
                    if (a < 35000) {
                        that.myItems.push(x);
                    }
                    else {
                        //remove this when we need filtering by location
                        that.myItems.push(x);
                    }
                }
            }, function (e) {
                //push anyway
                that.myItems.push(x);
            });
        });
    };
    ItemsComponent.prototype.tabSelectedFunction = function (a) {
        this.tabSelected = a;
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
            styleUrls: ["./items.component.css"]
        }),
        __metadata("design:paramtypes", [item_service_1.ItemService,
            router_2.Router,
            router_1.ActivatedRoute,
            nativescript_angular_1.RouterExtensions,
            auth_service_1.AuthService,
            order_service_1.OrderService,
            page_1.Page])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWdEO0FBRWhELHlEQUF1RDtBQUN2RCwwQ0FBK0M7QUFDL0MsMENBQXdDO0FBQ3hDLG1GQUFtRjtBQUNuRiw2REFBc0Q7QUFDdEQsMERBQXNEO0FBRXRELHlEQUFxRDtBQUVyRCwyREFBdUQ7QUFFdkQsdURBQTBEO0FBRTFELGlCQUFpQjtBQUNqQixxRUFBOEk7QUFHOUksZ0RBQTZDO0FBQzdDLGlEQUE4QztBQUM5QywwR0FBMEc7QUFDMUcseURBQXlEO0FBQ3pELGdDQUFnQztBQVVoQztJQXVCSSx3QkFBb0IsV0FBd0IsRUFDeEIsTUFBYSxFQUNiLEtBQW9CLEVBQ3BCLGdCQUFpQyxFQUNqQyxJQUFnQixFQUNoQixZQUF5QixFQUN6QixLQUFXO1FBTlgsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQUNiLFVBQUssR0FBTCxLQUFLLENBQWU7UUFDcEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQUNqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBQ3pCLFVBQUssR0FBTCxLQUFLLENBQU07UUE1Qi9CLGdCQUFXLEdBQVEsQ0FBQyxDQUFDO1FBRXJCLFVBQUssR0FBUyxFQUFFLENBQUM7UUFDakIsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUNsQixjQUFTLEdBQW9ELEVBQUUsQ0FBQztRQUNoRSxlQUFVLEdBQXFFLElBQUksa0NBQWUsQ0FBbUQsRUFBRSxDQUFDLENBQUM7UUFDekosV0FBTSxHQUF5QixJQUFJLGtDQUFlLENBQU8sRUFBRSxDQUFDLENBQUM7UUFDN0Qsc0JBQWlCLEdBQWdCLEVBQUUsQ0FBQztRQUNwQyw0QkFBdUIsR0FBZ0IsRUFBRSxDQUFDO1FBQzFDLGlCQUFZLEdBQWMsRUFB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TSxDQUFDLEVBQUU7WUFDbkIsV0FBVyxFQUFFLHdCQUF3QjtZQUNyQyxTQUFTLEVBQUMsQ0FBQyx1QkFBdUIsQ0FBQztTQUN0QyxDQUFDO3lDQXlCbUMsMEJBQVc7WUFDakIsZUFBTTtZQUNQLHVCQUFjO1lBQ0gsdUNBQWdCO1lBQzVCLDBCQUFXO1lBQ0gsNEJBQVk7WUFDbEIsV0FBSTtPQTdCdEIsY0FBYyxDQThQMUI7SUFBRCxxQkFBQztDQUFBLEFBOVBELElBOFBDO0FBOVBZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIE9uSW5pdH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEl0ZW0gfSBmcm9tIFwiLi4vZGF0YXR5cGVzL2l0ZW1cIjtcbmltcG9ydCB7IEl0ZW1TZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL2l0ZW0uc2VydmljZVwiO1xuaW1wb3J0IHtBY3RpdmF0ZWRSb3V0ZX0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuaW1wb3J0IHsgUm91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XG4vLyBpbXBvcnQgeyBNYXBib3hWaWV3QXBpLCBWaWV3cG9ydCBhcyBNYXBib3hWaWV3cG9ydCB9IGZyb20gXCJuYXRpdmVzY3JpcHQtbWFwYm94XCI7XG5pbXBvcnQge1JvdXRlckV4dGVuc2lvbnN9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhclwiO1xuaW1wb3J0IHtPYnNlcnZhYmxlQXJyYXl9IGZyb20gXCJkYXRhL29ic2VydmFibGUtYXJyYXlcIjtcbmltcG9ydCB7IFNlYXJjaEJhciB9IGZyb20gXCJ1aS9zZWFyY2gtYmFyXCI7XG5pbXBvcnQge0F1dGhTZXJ2aWNlfSBmcm9tIFwiLi4vc2VydmljZXMvYXV0aC5zZXJ2aWNlXCI7XG5pbXBvcnQge09yZGVyfSBmcm9tIFwiLi4vZGF0YXR5cGVzL29yZGVyXCI7XG5pbXBvcnQge09yZGVyU2VydmljZX0gZnJvbSBcIi4uL3NlcnZpY2VzL29yZGVyLnNlcnZpY2VcIjtcbmltcG9ydCB7T3JkZXJEaXNwbGF5fSBmcm9tIFwiLi4vZGF0YXR5cGVzL29yZGVyLmRpc3BsYXlcIjtcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpO1xuXG4vL3RyeWluZyBsb2NhdGlvblxuaW1wb3J0IHtMb2NhdGlvbiwgaXNFbmFibGVkLCBlbmFibGVMb2NhdGlvblJlcXVlc3QsIGdldEN1cnJlbnRMb2NhdGlvbiwgd2F0Y2hMb2NhdGlvbiwgZGlzdGFuY2UsIGNsZWFyV2F0Y2ggfSBmcm9tIFwibmF0aXZlc2NyaXB0LWdlb2xvY2F0aW9uXCI7XG5pbXBvcnQge0FjY3VyYWN5fSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9lbnVtcy9lbnVtc1wiO1xuaW1wb3J0IHtTdGFja0xheW91dH0gZnJvbSBcInVpL2xheW91dHMvc3RhY2stbGF5b3V0XCI7XG5pbXBvcnQge0NvbG9yfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9jb2xvclwiO1xuaW1wb3J0IHtQYWdlfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9wYWdlXCI7XG4vLyBpbXBvcnQge2FuZH0gZnJvbSBcIi4uLy4uL3BsYXRmb3Jtcy9pb3MvRFFDYWZldjAyL2FwcC90bnNfbW9kdWxlcy9AYW5ndWxhci9yb3V0ZXIvc3JjL3V0aWxzL2NvbGxlY3Rpb25cIjtcbi8vIHZhciBWaWJyYXRlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC12aWJyYXRlXCIpLlZpYnJhdGU7XG4vLyBsZXQgdmlicmF0b3IgPSBuZXcgVmlicmF0ZSgpO1xuXG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiBcIm5zLWl0ZW1zXCIsXG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICB0ZW1wbGF0ZVVybDogXCIuL2l0ZW1zLmNvbXBvbmVudC5odG1sXCIsXG4gICAgc3R5bGVVcmxzOltcIi4vaXRlbXMuY29tcG9uZW50LmNzc1wiXVxufSlcblxuZXhwb3J0IGNsYXNzIEl0ZW1zQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0e1xuICAgIHRhYlNlbGVjdGVkOk51bWJlcj0wO1xuICAgIGJ1c2luZXNzTmFtZTogU3RyaW5nW107XG4gICAgaXRlbXM6IEl0ZW1bXT1bXTtcbiAgICBteUl0ZW1zOkl0ZW1bXT1bXTtcbiAgICBvcmRlckxpc3Q6e1wib3JkZXJOb1wiOnN0cmluZyxcImNhZmVcIjpzdHJpbmcsXCJzdGF0dXNcIjpzdHJpbmd9W109W107XG4gICAgX29yZGVyTGlzdDpPYnNlcnZhYmxlQXJyYXk8e1wib3JkZXJOb1wiOnN0cmluZyxcImNhZmVcIjpzdHJpbmcsXCJzdGF0dXNcIjpzdHJpbmd9PiA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8e1wib3JkZXJOb1wiOnN0cmluZyxcImNhZmVcIjpzdHJpbmcsXCJzdGF0dXNcIjpzdHJpbmd9PihbXSk7XG4gICAgX2l0ZW1zOk9ic2VydmFibGVBcnJheTxJdGVtPiA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8SXRlbT4oW10pO1xuICAgIG9yZGVyQ29tcGxleExvY2FsOk9yZGVyRGlzcGxheVtdPVtdO1xuICAgIG9yZGVyQ29tcGxleExvY2FsRmlsdGVyOk9yZGVyRGlzcGxheVtdPVtdO1xuICAgIG9yZGVyRGlzcGxheTpPcmRlckRpc3BsYXk9e1wia2V5XCI6XCJcIixcInVpZFwiOlwiXCIsXCJzdGF0dXNcIjpcIlwiLFwib3JkZXJcIjogbnVsbCxcbiAgICAgICAgXCJjYWZlT3duZXJcIjpcIlwiLFwibG9jYXRpb25cIjpcIlwiLFwib3JkZXJObzJcIjpcIlwiLFwiaW1nU3JjXCI6XCJcIixcInRvdGFsXCI6XCJcIn1cbiAgICBfb3JkZXI6T2JzZXJ2YWJsZUFycmF5PE9yZGVyRGlzcGxheT4gPSBuZXcgT2JzZXJ2YWJsZUFycmF5PE9yZGVyRGlzcGxheT4oW10pO1xuICAgIGZyZXF1ZW50Q2FmZXM6c3RyaW5nW109W107XG5cblxuICAgIHN0YXJ0TG9jYXRpb246TG9jYXRpb249bmV3IExvY2F0aW9uKCk7XG5cbiAgICBwdWJsaWMgdGFiU2VsZWN0ZWRJbmRleDogbnVtYmVyO1xuICAgIHB1YmxpYyBzZWFyY2hQaHJhc2U6IHN0cmluZztcbiAgICB1c2VybmFtZTpzdHJpbmc9XCJcIjtcbiAgICBwcml2YXRlIF9jdXJyZW50Tm90aWZpY2F0aW9uOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGl0ZW1TZXJ2aWNlOiBJdGVtU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlcjpSb3V0ZXIsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByb3V0ZTpBY3RpdmF0ZWRSb3V0ZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlcmV4dGVuc2lvbnM6Um91dGVyRXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGF1dGg6QXV0aFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBvcmRlcnNlcnZpY2U6T3JkZXJTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgX3BhZ2U6IFBhZ2UpIHtcblxuICAgICAgICBpZih0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmFtc1tcInRhYklkXCJdICE9IG51bGwgJiYgdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJhbXNbXCJ0YWJJZFwiXSA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9wYWdlLmFjdGlvbkJhckhpZGRlbiA9IHRydWU7XG5cbiAgICAgICAgaWYodGhpcy5pdGVtcyE9W10pe1xuICAgICAgICAgICAgdGhpcy5pdGVtU2VydmljZS5sb2FkKClcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChpdGVtczogQXJyYXk8SXRlbT4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXRlbXMgPSBuZXcgT2JzZXJ2YWJsZUFycmF5KGl0ZW1zKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtcz1bXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXRlbXMuZm9yRWFjaCgoeCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMucHVzaCh4KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubXlJdGVtcy5sZW5ndGg9MDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJCeUxvY2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibm90IGxvYWRpbmcgYWdhaW5cIilcbiAgICAgICAgfVxuXG5cbi8vb3JkZXIgbG9hZCBmb3IgeW91ciBwaWNrc1xuICAgICAgICBmaXJlYmFzZS5nZXRDdXJyZW50VXNlcigpXG4gICAgICAgICAgICAudGhlbigodG9rZW4pPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRva2VuKTtcbiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyc2VydmljZS5sb2FkT3JkZXIodG9rZW4udWlkKVxuICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChvcmRlcmxpc3Q6IEFycmF5PHtcIm9yZGVyTm9cIjpzdHJpbmcsXCJjYWZlXCI6c3RyaW5nLFwic3RhdHVzXCI6c3RyaW5nfT4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJDb21wbGV4TG9jYWw9W107XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcmRlckxpc3QgPSBuZXcgT2JzZXJ2YWJsZUFycmF5KG9yZGVybGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyTGlzdD1bXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29yZGVyTGlzdC5mb3JFYWNoKCh4KT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJMaXN0LnB1c2goeCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckxpc3QuZm9yRWFjaCgoeCk9Pntcbi8vZ2V0IENhZmUgZGV0YWlsc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJzZXJ2aWNlLmdldE9yZGVyRGV0YWlscyh4LmNhZmUseC5vcmRlck5vKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0KT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuY2FmZU93bmVyPXRoaXMuaXRlbVNlcnZpY2UuZ2V0Q2FmZUluZm8oeC5jYWZlKS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuaW1nU3JjID0gdGhpcy5pdGVtU2VydmljZS5nZXRDYWZlSW5mbyh4LmNhZmUpLmltZ1NyYztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LmtleSA9IHJlc3VsdC52YWx1ZS5rZXk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS51aWQgPSByZXN1bHQudmFsdWUudWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuc3RhdHVzID0gcmVzdWx0LnZhbHVlLnN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5Lm9yZGVyTm8yID0gcmVzdWx0LnZhbHVlLm9yZGVyTm8yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkub3JkZXI9cmVzdWx0LnZhbHVlLm9yZGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkudG90YWw9dGhpcy50b3RhbFByaWNlKHRoaXMub3JkZXJEaXNwbGF5Lm9yZGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbC5wdXNoKHRoaXMub3JkZXJEaXNwbGF5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25UYXBDdXJyZW50T3JkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5PSB7XCJrZXlcIjpcIlwiLFwidWlkXCI6XCJcIixcInN0YXR1c1wiOlwiXCIsXCJvcmRlclwiOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiY2FmZU93bmVyXCI6XCJcIixcImxvY2F0aW9uXCI6XCJcIixcIm9yZGVyTm8yXCI6XCJcIixcImltZ1NyY1wiOlwiXCIsXCJ0b3RhbFwiOlwiXCJ9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMub250YXBMaXN0b2ZGcmVxdWVudCh0b2tlbi51aWQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICB9XG5cbi8vRnJlcXVlbnRseSB2aXNpdGVkIC0gdG8gYmUgY29tcGxldGVkIC4uLi5cbiAgICBvbnRhcExpc3RvZkZyZXF1ZW50KHRva2VuKXtcbiAgICAgICAgdmFyIGNvdW50czoge31bXTtcbiAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UuZnJlcXVlbnRDYWZlKHRva2VuKVxuICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhyZXMudmFsdWUpLmZvckVhY2goKHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlcXVlbnRDYWZlcy5wdXNoKHJlcy52YWx1ZVt4XS5jYWZlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKCk7XG4gICAgfVxuXG4vL05hdml0YWdlIHRvIG5leHQgc2NyZWVuXG4gICAganVtcHRvTWVudShjYWZlSWQsYXJncykge1xuICAgICAgICBsZXQgcGFnZSA9IDxTdGFja0xheW91dD5hcmdzLm9iamVjdDtcbiAgICAgICAgbGV0IHZpZXcgPSA8U3RhY2tMYXlvdXQ+cGFnZS5nZXRWaWV3QnlJZChcImNhZmVuYW1lXCIpO1xuICAgICAgICB2aWV3LmJhY2tncm91bmRDb2xvciA9IG5ldyBDb2xvcihcIiNmMGYwZjBcIik7XG4gICAgICAgIHZpZXcuYW5pbWF0ZSh7IGJhY2tncm91bmRDb2xvcjogbmV3IENvbG9yKFwid2hpdGVcIiksIGR1cmF0aW9uOiAyMDAgfSk7XG5cbiAgICAgICAgdGhpcy5yb3V0ZXJleHRlbnNpb25zLm5hdmlnYXRlKFtcIi9jYWZlXCIsIGNhZmVJZF0pO1xuICAgIH1cbi8vXG4vLyAvL1RhYlZpZXcgY29udHJvbHNcbiAgICBjaGFuZ2VUYWIoKSB7XG5cbiAgICAgICAgaWYgKHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhYlNlbGVjdGVkSW5kZXggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9IDI7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50YWJTZWxlY3RlZEluZGV4ID09PSAyKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAwO1xuICAgICAgICB9XG5cblxuICAgIH1cblxuLy8gc2VhcmNoIGJhclxuXG4gICAgcHVibGljIG9uVGV4dENoYW5nZWQoYXJncykge1xuXG4gICAgICAgIGxldCBzZWFyY2hCYXIgPSA8U2VhcmNoQmFyPmFyZ3Mub2JqZWN0O1xuICAgICAgICBpZiAoc2VhcmNoQmFyLnRleHQhPVwiXCIpe1xuICAgICAgICAgICAgbGV0IHNlYXJjaFZhbHVlID0gc2VhcmNoQmFyLnRleHQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGlmIChzZWFyY2hCYXIudGV4dCAhPSBcIlwiKXtcbiAgICAgICAgICAgICAgICB0aGlzLm15SXRlbXMgPSB0aGlzLml0ZW1zLmZpbHRlciggaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtpdGVtLm5hbWV9ICR7aXRlbS5uYW1lfWAudG9Mb3dlckNhc2UoKS5pbmRleE9mKHNlYXJjaFZhbHVlLnRvTG93ZXJDYXNlKCkpID4gLTE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBzZWFyY2hCYXIuZGlzbWlzc1NvZnRJbnB1dCgpO1xuICAgICAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIC8vIHRoaXMubXlJdGVtcy5sZW5ndGg9MDtcbiAgICAgICAgICAgIC8vIHRoaXMuZmlsdGVyQnlMb2NhdGlvbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VhcmNoTG9hZGVkKGV2ZW50KSB7XG4gICAgICAgIHRoaXMuc2VhcmNoUGhyYXNlID0gXCJcIjtcbiAgICAgICAgZXZlbnQub2JqZWN0LmFuZHJvaWQuc2V0Rm9jdXNhYmxlKGZhbHNlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25TdWJtaXQoYXJncykge1xuICAgICAgICBsZXQgc2VhcmNoYmFyID0gPFNlYXJjaEJhcj5hcmdzLm9iamVjdDtcbiAgICAgICAgc2VhcmNoYmFyLmRpc21pc3NTb2Z0SW5wdXQoKTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBvbkNsZWFyKGFyZ3MpIHtcbiAgICAgICAgbGV0IHNlYXJjaGJhciA9IDxTZWFyY2hCYXI+YXJncy5vYmplY3Q7XG4gICAgICAgIHNlYXJjaGJhci5kaXNtaXNzU29mdElucHV0KCk7XG4gICAgfVxuXG5cbiAgICBvblJlZ2lzdGVyKCl7XG5cbiAgICAgICAgdGhpcy5yb3V0ZXJleHRlbnNpb25zLm5hdmlnYXRlKFsncmVnaXN0ZXInXSk7XG5cbiAgICB9XG5cbiAgICBvblNpZ25pbigpe1xuXG4gICAgICAgIHRoaXMucm91dGVyZXh0ZW5zaW9ucy5uYXZpZ2F0ZShbJ3NpZ25pbiddKTtcblxuICAgIH1cblxuICAgIG9uU2lnbm91dCgpe1xuXG4gICAgICAgIHRoaXMuYXV0aC5zaWdub3V0KCk7XG4gICAgfVxuXG5cbi8vRm9yIHlvdXIgcGlja3MuLi5cbiAgICB0b3BUaHJlZUNhZmVzKCl7XG5cbiAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UuZnJlcXVlbnRDYWZlKFwiQ0JOVWx1QTZGb2dWSWtPU2xENFdLT0Z2TWpmMVwiKTtcblxuICAgIH1cblxuXG4gICAgb25UYXBDdXJyZW50T3JkZXIoKXtcbiAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbEZpbHRlciA9IHRoaXMub3JkZXJDb21wbGV4TG9jYWwuZmlsdGVyKGZ1bmN0aW9uICh4KSB7XG4gICAgICAgICAgICByZXR1cm4geC5zdGF0dXMgIT0gXCJjb2xsZWN0ZWRcIlxuXG4gICAgICAgIH0pXG4gICAgfVxuXG5cbiAgICBvblRhcFBhc3RPcmRlcnMoKXtcbiAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbEZpbHRlciA9IHRoaXMub3JkZXJDb21wbGV4TG9jYWwuZmlsdGVyKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIHJldHVybiB4LnN0YXR1cyA9PT0gXCJjb2xsZWN0ZWRcIlxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHRvdGFsUHJpY2Uob3JkZXI6T3JkZXJbXSl7XG4gICAgICAgIHZhciB0b3RhbD1cIjBcIjtcbiAgICAgICAgb3JkZXIuZm9yRWFjaCgoeCk9PntcbiAgICAgICAgICAgIC8vZm9yIHRvdGFsXG4gICAgICAgICAgICB0b3RhbD0oTWF0aC5yb3VuZCgocGFyc2VGbG9hdCh0b3RhbCkrIHBhcnNlRmxvYXQoeC5wcmljZVF1YW50aXR5KSkqMTAwKS8xMDApLnRvU3RyaW5nKCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdG90YWw7XG4gICAgfVxuXG4gICAgZmlsdGVyQnlMb2NhdGlvbigpe1xuICAgICAgICBjb25zdCBkYXRlOiBEYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKCh4KT0+e1xuXG4gICAgICAgICAgICB0aGlzLm15SXRlbXMubGVuZ3RoPTA7XG4gICAgICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XG5cbiAgICAgICAgICAgIGdldEN1cnJlbnRMb2NhdGlvbih7ZGVzaXJlZEFjY3VyYWN5OiAxLCB1cGRhdGVEaXN0YW5jZTogMTAsIG1heGltdW1BZ2U6IDIwMDAwLCB0aW1lb3V0OiA1MDAwfSkuXG4gICAgICAgICAgICB0aGVuKGZ1bmN0aW9uKGxvYykge1xuICAgICAgICAgICAgICAgIGlmIChsb2MpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGEgPSBkaXN0YW5jZShsb2Mse1wibGF0aXR1ZGVcIjp4LmxhdCxcImxvbmdpdHVkZVwiOngubG5nLCBcImRpcmVjdGlvblwiOjAsIFwiaG9yaXpvbnRhbEFjY3VyYWN5XCI6MTQsXG4gICAgICAgICAgICAgICAgICAgICAgICBcInZlcnRpY2FsQWNjdXJhY3lcIjoxNCxcInNwZWVkXCI6MCxcImFsdGl0dWRlXCI6ODksXCJ0aW1lc3RhbXBcIjpkYXRlfSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKGE8MzUwMDApe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vcmVtb3ZlIHRoaXMgd2hlbiB3ZSBuZWVkIGZpbHRlcmluZyBieSBsb2NhdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgICAgICAvL3B1c2ggYW55d2F5XG4gICAgICAgICAgICAgICAgdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHRhYlNlbGVjdGVkRnVuY3Rpb24oYTpOdW1iZXIpe1xuICAgICAgICB0aGlzLnRhYlNlbGVjdGVkPWE7XG4gICAgfVxuXG59XG4iXX0=